import {
queryAreasByCityApi,
queryCitiesByProvinceApi,
queryProvincesApi,
saveOrUpdateOrgApi,
} from '@/services/system';
import { orgLevel } from '@/utils/enum';
import { Cascader, Form, Input, message, Select, TreeSelect } from 'antd';
import { forwardRef, useEffect, useState } from 'react';
let geocoder, markers, map;
const OrgForm = forwardRef((props, ref) => {
const { itemData, orgList } = props;
const [form] = Form.useForm();
const [options, setOptions] = useState([]);
const [address, setAddress] = useState([]);
const [location, setLocation] = useState('');
const queryCitiesByProvinceFn = async (params) => {
return await queryCitiesByProvinceApi(params);
};
const queryAreasByCityFn = async (params) => {
return await queryAreasByCityApi(params);
};

const queryProvincesFn = async () => {
const prov = await queryProvincesApi();
if (prov && prov.data) {
let options = prov.data.map((item) => {
return {
label: item.fullName,
value: item.fullCode,
level: 1,
isLeaf: false,
};
});
let zip = itemData?.zipList;
if (zip && zip.length > 1) {
const city = await queryCitiesByProvinceFn({ provinceCode: zip[0] });
if (city && city.data) {
let optionsCity = city.data.map((item) => {
return {
label: item.fullName,
value: item.fullCode,
level: 2,
isLeaf: false,
};
});
if (zip.length > 2) {
const area = await queryAreasByCityFn({ cityCode: zip[1] });
if (area && area.data) {
let optionsArea = area.data.map((item) => {
return {
label: item.fullName,
value: item.fullCode,
level: 3,
isLeaf: true,
};
});
optionsCity = optionsCity.map((item) => {
if (item.value === zip[1]) {
return {
...item,
children: optionsArea,
};
} else {
return item;
}
});
options = options.map((item) => {
if (item.value === zip[0]) {
return {
...item,
children: optionsCity,
};
} else {
return item;
}
});
setOptions(options);
}
} else {
options = options.map((item) => {
if (item.value === zip[0]) {
return {
...item,
children: optionsCity,
};
} else {
return item;
}
});
setOptions(options);
}
} else {
setOptions(options);
}
} else {
setOptions(options);
}
}
};
const loadData = (selectedOptions) => {
const targetOption = selectedOptions[selectedOptions.length - 1];
targetOption.loading = true;
if (targetOption.level === 1) {
queryCitiesByProvinceFn({ provinceCode: targetOption.value }).then((res) => {
if (res.data) {
const opts = res.data.map((item) => {
return {
label: item.fullName,
value: item.fullCode,
level: 2,
isLeaf: false,
};
});
targetOption.loading = false;
targetOption.children = opts;
setOptions([...options]);
}
});
} else {
queryAreasByCityFn({ cityCode: targetOption.value }).then((res) => {
if (res.data) {
const opts = res.data.map((item) => {
return {
label: item.fullName,
value: item.fullCode,
level: 3,
isLeaf: true,
};
});
targetOption.loading = false;
targetOption.children = opts;
setOptions([...options]);
}
});
}
};
const submitValue = () => {
return new Promise((resolve, reject) => {
form
.validateFields()
.then((res) => {
if (itemData) {
return saveOrUpdateOrgApi({ ...res, uuid: itemData.uuid });
} else {
return saveOrUpdateOrgApi({ ...res });
}
})
.then((res) => {
if (res.success) {
form.resetFields();
message.success(itemData ? '编辑成功' : '新增成功');
resolve(true);
}
})
.catch((err) => {
reject(false);
console.error(err, 'drx-error');
});
});
};
useEffect(() => {
queryProvincesFn();
if (ref.current) {
ref.current.submitValue = submitValue;
}
let TMap = window.TMap;
map = new TMap.Map('map-container', {
rotation: 20, //设置地图旋转角度
pitch: 30, //设置俯仰角度（0~45）
zoom: 12, //设置地图缩放级别
center: new TMap.LatLng(39.986785, 116.301012), //设置地图中心点坐标
});
geocoder = new TMap.service.Geocoder(); // 新建一个正逆地址解析类
markers = new TMap.MultiMarker({
map: map,
geometries: [],
});
map.on('click', function (evt) {
let lat = evt.latLng.getLat().toFixed(6);
let lng = evt.latLng.getLng().toFixed(6);
let location = { lat, lng, height: 0 };
console.log(location);
geocoder
.getAddress({ location: location }) // 将给定的坐标位置转换为地址
.then((result) => {
console.log(result.result.address);
});
});
}, []);
useEffect(() => {
markers.setGeometries([]);
geocoder.getLocation({ address: address[address.length - 1] }).then((result) => {
let location = result.result.location;
console.log(location);
markers.updateGeometries([
{
id: 'map-container',
position: location, // 将得到的坐标位置用点标记标注在地图上
},
]);
map.setCenter(location);
geocoder
.getAddress({ location: location }) // 将给定的坐标位置转换为地址
.then((result) => {
console.log(result.result.address);
});
});
}, [address]);

return (
<>
<Form
  name="basic"
  labelCol={{
  span: 6,
  }}
  wrapperCol={{
  span: 16,
  }}
  ref={ref}
  form={form}
  initialValues={itemData}
  autoComplete="off"
>
  <Form.Item
    label="上级机构"
    name="parentInnerCode"
    rules={[{ required: true, message: '上级机构必选' }]}
  >
  <TreeSelect
    disabled={itemData}
    placeholder="请选择上级机构"
    style={{ width: '100%' }}
  dropdownStyle={{
  maxHeight: '400',
  overflow: 'auto',
  }}
  treeData={orgList}
  treeDefaultExpandAll
  />
  </Form.Item>
  
  <Form.Item
    label="机构名称"
    name="name"
    rules={[{ required: true, message: '机构名称必填!' }]}
  >
  <Input placeholder="请输入机构名称" />
  </Form.Item>
  <Form.Item
    label="机构编号"
    name="code"
    rules={[{ required: true, message: '机构编号必填!' }]}
  >
  <Input placeholder="请输入机构编号" />
  </Form.Item>
  <Form.Item label="级别" name="level">
    <Select placeholder="请选择级别">
      {orgLevel.map((item) => {
      return (
      <Select.Option key={item.key} value={item.key}>
        {item.value}
      </Select.Option>
      );
      })}
    </Select>
  </Form.Item>
  <Form.Item
    label="人行保证系统机构编码"
    name="pbgsiCode"
    rules={[{ required: true, message: '人行保证系统机构编码必填!' }]}
  >
  <Input placeholder="请输入人行保证系统机构编码" />
  </Form.Item>
  <Form.Item
    label="人行金融机构代码"
    name="pbocCode"
    rules={[{ required: true, message: '人行金融机构代码必填!' }]}
  >
  <Input placeholder="请输入人行金融机构代码" />
  </Form.Item>
  <Form.Item
    label="营业执照名称"
    name="licenceName"
    rules={[{ required: true, message: '营业执照名称必填!' }]}
  >
  <Input placeholder="请输入营业执照名称" />
  </Form.Item>
  <Form.Item
    label="统一社会信用代码"
    name="creditNo"
    rules={[{ required: true, message: '统一社会信用代码必填!' }]}
  >
  <Input placeholder="请输入统一社会信用代码" />
  </Form.Item>
  
  <Form.Item
    label="联系电话"
    name="phone"
    rules={[
    { required: true, message: '联系电话必填!' },
  { pattern: /[0-9_]{2,}/, message: '联系电话格式不正确' },
  ]}
  >
  <Input placeholder="请输入联系电话" />
  </Form.Item>
  <Form.Item label="所在区域" name="zipList">
    <Cascader
      allowClear
      placeholder="请选择所在区域"
      options={options}
      loadData={loadData}
      changeOnSelect
      onChange={(value, selectedOptions) => {
      setAddress(
      selectedOptions.map((item) => {
      return item.label;
      }),
      );
      }}
      />
  </Form.Item>
  <Form.Item label="具体地址" name="loc">
    <Input placeholder="请输入具体地址" />
  </Form.Item>
</Form>
<div id="map-container"></div>
</>
);
});

export default OrgForm;
